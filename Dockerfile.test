# Test runner Docker image for AutoGen platform
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements files first for better caching
COPY services/api-gateway/requirements.txt /tmp/api-requirements.txt
COPY services/core-engine/requirements.txt /tmp/core-requirements.txt
COPY services/agent-manager/requirements.txt /tmp/agent-requirements.txt
COPY customer_agents/base/requirements.txt /tmp/customer-requirements.txt

# Install test dependencies
RUN pip install --no-cache-dir \
    pytest==7.4.3 \
    pytest-asyncio==0.21.1 \
    pytest-cov==4.1.0 \
    pytest-timeout==2.2.0 \
    pytest-mock==3.12.0 \
    pytest-xdist==3.5.0 \
    pytest-html==4.1.1 \
    pytest-json-report==1.5.0 \
    httpx==0.25.2 \
    websockets==12.0 \
    aio-pika==9.3.1 \
    redis==5.0.1 \
    faker==20.1.0 \
    locust==2.17.0 \
    black==23.12.0 \
    flake8==6.1.0 \
    mypy==1.7.1 \
    bandit==1.7.5 \
    coverage==7.3.2 \
    requests \
    colorama

# Install service requirements
RUN pip install --no-cache-dir -r /tmp/api-requirements.txt \
    && pip install --no-cache-dir -r /tmp/core-requirements.txt \
    && pip install --no-cache-dir -r /tmp/agent-requirements.txt \
    && pip install --no-cache-dir -r /tmp/customer-requirements.txt

# Copy test files and source code
COPY tests/ /app/tests/
COPY services/ /app/services/
COPY customer_agents/ /app/customer_agents/
COPY shared/ /app/shared/
COPY scripts/ /app/scripts/

# Set Python path
ENV PYTHONPATH=/app

# Create results directory
RUN mkdir -p /results /app/test_results

# Make scripts executable
RUN chmod +x /app/scripts/*.py || true
RUN chmod +x /app/scripts/*.sh || true

# Default command runs all tests
CMD ["pytest", "-v", "--color=yes", "--tb=short", "--junitxml=/results/test-results.xml"]